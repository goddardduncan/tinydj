<script>
const modal = document.getElementById('settingsModal');
const hostIpInput = document.getElementById('hostIp');
const ipDisplay = document.getElementById('ip-display');
const ssidInput = document.getElementById('ssid');
const passInput = document.getElementById('pass');

window.addEventListener('DOMContentLoaded', () => {
    const savedIp = localStorage.getItem('tinyDjHostIp') || "0.0.0.0";
    hostIpInput.value = savedIp;
    ipDisplay.innerText = `IP: ${savedIp}`;
});

hostIpInput.addEventListener('input', () => {
    const val = hostIpInput.value.trim();
    localStorage.setItem('tinyDjHostIp', val);
    ipDisplay.innerText = `IP: ${val}`;
});

function toggleModal() {
    modal.classList.toggle('modal-open');
    ssidInput.classList.remove('error');
    passInput.classList.remove('error');
}

// ---- BLE WiFi Send + IP Receive ----
const SERVICE_UUID = '12345678-1234-5678-1234-567812345678';
const CHAR_UUID = '87654321-4321-8765-4321-876543210987';

async function connectAndSend() {
    const ssid = ssidInput.value.trim();
    const pass = passInput.value.trim();

    if (!ssid || !pass) {
        if (!ssid) ssidInput.classList.add("error");
        if (!pass) passInput.classList.add("error");
        updateStatus("Missing WiFi details", "#ff4444");
        return;
    }

    try {
        toggleLoader(true);
        updateStatus("Scanning...");

        const device = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: "tinyDJ" }],
            optionalServices: [SERVICE_UUID]
        });

        updateStatus("Connecting...");
        const server = await device.gatt.connect();

        updateStatus("Getting service...");
        const service = await server.getPrimaryService(SERVICE_UUID);

        updateStatus("Getting characteristic...");
        const characteristic = await service.getCharacteristic(CHAR_UUID);

        // ----- Listen for Pi sending IP back -----
        await characteristic.startNotifications();
        characteristic.addEventListener("characteristicvaluechanged", ev => {
            const txt = new TextDecoder().decode(ev.target.value);
            console.log("BLE Notify:", txt);

            try {
                const { ip } = JSON.parse(txt);
                if (ip) {
                    localStorage.setItem("tinyDjHostIp", ip);
                    hostIpInput.value = ip;
                    ipDisplay.innerText = `IP: ${ip}`;
                    updateStatus("IP Received!", "var(--cyan)");
                }
            } catch (err) {}
        });

        // ----- Write WiFi credentials -----
        updateStatus("Sending WiFi...");
        const payload = new TextEncoder().encode(JSON.stringify({ ssid, pass }));
        await characteristic.writeValueWithoutResponse(payload);

        updateStatus("Waiting for IP...", "var(--cyan)");

        // Close modal after short delay
        setTimeout(() => {
            toggleModal();
            toggleLoader(false);
        }, 1500);

    } catch (err) {
        console.error(err);
        updateStatus("ERROR: " + err.message, "#ff4444");
        toggleLoader(false);
    }
}

function updateStatus(msg, color = "#555") {
    const s = document.getElementById('status');
    s.innerText = msg;
    s.style.color = color;
}

function toggleLoader(state) {
    document.getElementById("loader").style.display = state ? "block" : "none";
    document.getElementById("btBtn").disabled = state;
}
</script>
