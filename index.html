<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Zero Setup</title>
    <style>
        :root { --g-blue: #4285f4; --g-red: #ea4335; --text: #3c4043; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fa; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; color: var(--text); }
        .card { background: white; width: 100%; max-width: 360px; padding: 40px 24px; border-radius: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        .dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        h1 { font-size: 26px; font-weight: 500; margin: 0 0 12px; }
        p { color: #5f6368; font-size: 15px; line-height: 1.6; margin-bottom: 32px; }
        .input-group { margin-bottom: 16px; text-align: left; }
        label { display: block; font-size: 12px; margin-bottom: 6px; margin-left: 4px; color: #5f6368; font-weight: 600; }
        input { width: 100%; padding: 14px; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none; transition: border 0.2s; }
        input:focus { border: 2px solid var(--g-blue); padding: 13px; }
        button { background: var(--g-blue); color: white; border: none; padding: 16px; border-radius: 30px; font-size: 16px; font-weight: 500; cursor: pointer; width: 100%; margin-top: 10px; transition: background 0.2s; }
        button:hover { background: #1a73e8; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin-top: 24px; font-size: 13px; min-height: 20px; line-height: 1.4; transition: color 0.2s; }
        .loader { display: none; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--g-blue); border-radius: 50%; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="card">
        <div class="dots">
            <div id="dot1" class="dot" style="background:#4285f4"></div>
            <div class="dot" style="background:#ea4335"></div>
            <div class="dot" style="background:#fbbc05"></div>
            <div class="dot" style="background:#34a853"></div>
        </div>
        
        <h1>Connect your Pi</h1>
        <p>Enter the WiFi credentials for your Raspberry Pi Zero. Select the device starting with <b>B8:27</b> in the next step.</p>
        
        <div class="input-group">
            <label>WIFI NAME (SSID)</label>
            <input type="text" id="ssid" placeholder="Home WiFi" spellcheck="false">
        </div>
        
        <div class="input-group">
            <label>PASSWORD</label>
            <input type="password" id="pass" placeholder="••••••••">
        </div>
        
        <button id="mainBtn" onclick="connectAndSend()">Connect Device</button>
        <div class="loader" id="loader"></div>
        <div id="status">Ready to scan</div>
    </div>

    <script>
        // MUST MATCH YOUR bluetoothctl UUIDs EXACTLY
        const SERVICE_UUID = '12345678-1234-5678-1234-567812345678';
        const CHAR_UUID = '87654321-4321-8765-4321-876543210987';

        async function connectAndSend() {
            const status = document.getElementById('status');
            const loader = document.getElementById('loader');
            const btn = document.getElementById('mainBtn');
            const ssid = document.getElementById('ssid').value;
            const pass = document.getElementById('pass').value;

            if (!ssid || !pass) {
                updateStatus("Please enter WiFi details first.", "#ea4335");
                return;
            }

            try {
                toggleUI(true);
                updateStatus("Requesting Device... (Select B8:27...)");

                // Request device with explicit optionalServices
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus("Connecting to Pi...");
                const server = await device.gatt.connect();

                // Small delay to allow GATT database discovery
                updateStatus("Discovering Services...");
                await new Promise(resolve => setTimeout(resolve, 1000));

                const service = await server.getPrimaryService(SERVICE_UUID);
                const characteristic = await service.getCharacteristic(CHAR_UUID);

                updateStatus("Sending Credentials...");
                const data = JSON.stringify({ ssid, pass });
                const encoder = new TextEncoder();
                await characteristic.writeValue(encoder.encode(data));

                updateStatus("✅ Credentials Sent! Pi is connecting...", "#34a853");
                toggleUI(false);

            } catch (err) {
                console.error(err);
                updateStatus("Error: " + err.message, "#ea4335");
                toggleUI(false);
            }
        }

        function updateStatus(msg, color = "#4285f4") {
            const status = document.getElementById('status');
            status.innerText = msg;
            status.style.color = color;
        }

        function toggleUI(loading) {
            const loader = document.getElementById('loader');
            const btn = document.getElementById('mainBtn');
            loader.style.display = loading ? "block" : "none";
            btn.disabled = loading;
        }
    </script>
</body>
</html>
